<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KNOCK — Update KNOCK-UPDATE-004.4</title>
  <style>
    :root{--accent:#805E85;--accent-strong:#6b4c70;--bg:#6b4c70;--panel-border:rgba(107,76,112,0.06);--card-accent-strip:rgba(128,94,133,0.16)}
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;padding:28px;background:var(--bg);color:#111}
    .wrap{max-width:640px;margin:0 auto}
    .panel{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;border:1px solid var(--panel-border);background:#fff;box-shadow:0 6px 18px rgba(107,76,112,0.04)}
    .left{width:120px;display:flex;flex-direction:column;gap:6px}
    .label{font-size:12px;font-weight:600;color:#333}
    .letter-pill{padding:12px;border-radius:10px;border:1px solid #e6e6ea;background:#fff;font-size:20px;text-align:center}
    .divider{width:1px;height:44px;background:linear-gradient(#fff,#eee);margin-left:-6px;margin-right:6px}
    .right{flex:1;display:flex;flex-direction:column}
    .emotion-full{padding:12px;border-radius:10px;border:1px solid #e6e6ea;background:#fff;font-size:20px;text-align:center}
    .emotion-full:focus,.letter-pill:focus{outline:3px solid rgba(128,94,133,0.12);outline-offset:2px}
    .controls-row{width:100%;max-width:640px;margin:12px auto 0;display:flex;justify-content:flex-end;gap:8px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #e6e6ea;background:#fff;font-size:14px;cursor:pointer;color:inherit}
    .btn.active{background:#fff;border-color:#e6e6ea;color:inherit}.btn:hover{background:#fff}
    /* Back button made subtler */
    .back-btn{display:none;opacity:0.7;font-size:13px;padding:6px 10px}
    /* Restore button for flat favorites (subtle inline control) */
    .restore-btn{display:none;padding:6px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.12);color:#fff;font-size:13px;opacity:0.9}
    #panelCounts{color:var(--accent);font-size:13px}
    .cards{width:100%;max-width:640px;margin:12px auto 0;display:flex;flex-direction:column;gap:12px}
    .card{background:var(--accent);color:#fff;border-radius:12px;padding:16px;box-shadow:0 8px 20px rgba(22,28,45,0.06);border:1px solid rgba(0,0,0,0.04);position:relative;opacity:0;transform:translateY(10px)}
    .card.enter{opacity:1;transform:none;transition:opacity 140ms ease, transform 140ms ease}
    .card strong{display:block;font-size:18px;margin-bottom:6px}
    .card p{margin:0;font-size:15px;color:#333;line-height:1.4}
    .card.selected::before{content:"";position:absolute;left:0;top:0;bottom:0;width:6px;border-radius:12px 0 0 12px;background:linear-gradient(180deg,var(--card-accent-strip),rgba(107,76,112,0.08))}
    .card .actions{position:absolute;top:12px;right:12px;display:flex;gap:8px}
    .icon-btn{background:transparent;border:0;padding:6px;border-radius:8px;cursor:pointer;font-size:16px}
    .icon-btn.heart[aria-pressed="true"]{color:#e0245e}
    .modal-backdrop{position:fixed;inset:0;background:rgba(10,12,16,0.4);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:#fff;padding:20px;border-radius:12px;box-shadow:0 20px 60px rgba(22,28,45,0.2);max-width:720px;width:100%;max-height:80vh;overflow:auto}.modal h3{margin:0 0 12px 0;font-size:20px;color:#111}
    .modal textarea{box-sizing:border-box;width:100%;max-width:100%;min-height:90px;padding:10px;font-size:15px;border-radius:8px;border:1px solid #e6e6ea;display:block}
    .modal .row{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .note-item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:8px;border:1px solid #eef2f6;background:#fff;margin-bottom:12px;color:#111} .note-text{flex:1;padding-right:12px;color:#111} .note-item .btn{margin-left:12px}
    .note-text{flex:1;margin-right:8px}
    .muted{color:#666;font-size:13px}
    .letter-pill,.emotion-full,.btn{background:#a693a9;color:#fff;border-color:rgba(0,0,0,0.08)}
    .letter-pill option,.emotion-full option{color:#fff;background:#a693a9}.letter-pill,.emotion-full{-webkit-appearance:none;appearance:none}.btn{color:#fff}.btn.active{background:#a693a9;color:#fff}.btn:hover{filter:brightness(0.96)}.card,.card *{color:#fff!important}.card .icon-btn.heart[aria-pressed="true"]{color:#e0245e!important}
    @media(max-width:520px){.panel{flex-direction:column;gap:10px}.divider{display:none}.left{width:100%}.wrap{padding:12px}.controls-row{justify-content:center}.modal{margin:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:0 0 12px 0;font-size:18px;text-align:center;color:#fff">KNOCK</h2>
    <div class="panel">
      <div class="left">
        <div class="label">Letter</div>
        <select id="letterSelect" class="letter-pill" aria-label="Select letter">
          <option value="">--</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select>
      </div>
      <div class="divider" aria-hidden="true"></div>

      <div class="right" style="position:relative">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div class="label">Category</div>
          <div id="panelCounts" class="muted"></div>
        </div>
        <select id="emotionSelect" class="emotion-full" aria-label="Select emotion" disabled>
          <option value="">-- pick a letter first --</option>
        </select>
      </div>
    </div>
    <div class="controls-row">
      <button id="notesBtn" class="btn" title="Notes">Notes (0)</button>
      <button id="favoritesToggle" class="btn" title="Show favorites">Favorites (0)</button>
      <button id="restoreBtn" class="restore-btn" title="Back">Back</button>
      <button id="backBtn" class="btn back-btn">Back</button>
      <button id="showMoreBtn" class="btn" style="display:none">Show more</button>
    </div>
    <div id="scriptures" class="cards" aria-live="polite">
      <em style="margin-top:14px;display:block;text-align:center;color:#666">Choose a letter and emotion to view verses.</em>
    </div>
  </div>
  <div id="modalRoot"></div>
  <script>
    const PER_PAGE = 6;
    const STORAGE_FAVS = 'knock_favs_v1';
    const STORAGE_NOTES = 'knock_notes_v1';

    const DATA = { A: { Anxiety: [ {verse: "Philippians 4:6-7", text: "Do not be anxious about anything; pray and present your requests to God."}, {verse: "1 Peter 5:7", text: "Cast all your anxiety on him because he cares for you."}, {verse: "Matthew 6:34", text: "Do not worry about tomorrow, for tomorrow will worry about itself."}, {verse: "Psalm 55:22", text: "Cast your burden on the LORD, and he will sustain you."}, {verse: "Isaiah 41:10", text: "Fear not, for I am with you; be not dismayed, for I am your God."}, {verse: "John 14:27", text: "Peace I leave with you; my peace I give to you."}, {verse: "Psalm 34:4", text: "I sought the LORD, and he answered me and delivered me from all my fears."} ], Anger: [ {verse: "Ephesians 4:26", text: "In your anger do not sin."}, {verse: "James 1:19-20", text: "Be quick to hear, slow to speak, slow to anger."}, {verse: "Proverbs 15:1", text: "A soft answer turns away wrath, but a harsh word stirs up anger."} ] }, B: { Bitterness: [ {verse: "Hebrews 12:15", text: "See to it that no bitter root grows up to cause trouble."}, {verse: "Ephesians 4:31-32", text: "Put away bitterness and be kind to one another."} ] }, C: { Confusion: [ {verse: "Proverbs 3:5", text: "Trust in the LORD with all your heart and do not rely on your own understanding."}, {verse: "Isaiah 55:8-9", text: "My thoughts are not your thoughts, neither are your ways my ways, declares the LORD."} ] } };

    // state
    let favs = [];
    let notes = {};
    let favoritesView = false;
    let prevState = null;
    let currentItems = [];
    let visibleCount = PER_PAGE;
    let favoritesModalOpen = false;

    // elements
    const letterSelect = document.getElementById('letterSelect');
    const emotionSelect = document.getElementById('emotionSelect');
    const scriptures = document.getElementById('scriptures');
    const favoritesToggle = document.getElementById('favoritesToggle');
    const notesBtn = document.getElementById('notesBtn');
    const backBtn = document.getElementById('backBtn');
    const restoreBtn = document.getElementById('restoreBtn');
    const panelCounts = document.getElementById('panelCounts');
    const showMoreBtn = document.getElementById('showMoreBtn');

    /* -------------------- helper functions (defined first to avoid hoisting issues) -------------------- */
    function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
    function renderMessage(msg){ scriptures.innerHTML = '<em style="text-align:center;color:#666">'+escapeHtml(msg)+'</em>'; if (showMoreBtn) showMoreBtn.style.display='none'; }

    function loadFavs(){ try{ return JSON.parse(localStorage.getItem(STORAGE_FAVS))||[] }catch(e){return[]} }
    function saveFavs(){ localStorage.setItem(STORAGE_FAVS, JSON.stringify(favs)); }
    function toggleFav(key){ if (!key) return; const i = favs.indexOf(key); if (i>-1) { favs.splice(i,1); } else { favs.push(key); } saveFavs(); updatePanelCounts(); }

    function loadNotes(){ try{ return JSON.parse(localStorage.getItem(STORAGE_NOTES))||{} }catch(e){return{}} }
    function saveNotes(){ localStorage.setItem(STORAGE_NOTES, JSON.stringify(notes)); }

    function makeKey(letter, emotion, verse){ return [letter, emotion, verse].join('|'); }
    function makeCategoryKey(letter, emotion){ return [letter, emotion].join('|'); }

    function existsInDataKey(key){ if (!key) return false; const parts = key.split('|'); const letter = parts[0] || ''; const emotion = parts[1] || ''; const verse = parts.slice(2).join('|') || ''; return !!(DATA[letter] && DATA[letter][emotion] && DATA[letter][emotion].some(item => item.verse === verse)); }

    function getAllFavItems(){ const rows = []; Object.keys(DATA).forEach(letter=>{ Object.keys(DATA[letter]).forEach(em=>{ DATA[letter][em].forEach(item=>{ const key = makeKey(letter, em, item.verse); if (favs.includes(key)) rows.push({...item, _letter: letter, _emotion: em}); }); }); }); return rows; }

    // gather all favorites grouped by letter->emotion (used by grouped modal)
    function gatherAllFavorites(){ const grouped = {}; (favs||[]).forEach(key=>{ if (!existsInDataKey(key)) return; const parts = key.split('|'); const letter = parts[0] || ''; const em = parts[1] || ''; const verse = parts.slice(2).join('|') || ''; if (!letter) return; grouped[letter] = grouped[letter] || {}; grouped[letter][em] = grouped[letter][em] || []; const item = (DATA[letter] && DATA[letter][em] && DATA[letter][em].find(it => it.verse === verse)); if (item) grouped[letter][em].push(item); }); return grouped; }

    // open grouped favorites modal (defined before use)
    function openAllFavoritesModal(){ const root = document.getElementById('modalRoot'); root.innerHTML = ''; const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop'; backdrop.tabIndex = -1; const modal = document.createElement('div'); modal.className = 'modal'; const title = document.createElement('h3'); title.textContent = 'All Favorites'; modal.appendChild(title);
      const grouped = gatherAllFavorites(); if (Object.keys(grouped).length===0){ const em = document.createElement('div'); em.className='muted'; em.textContent='No favorites yet.'; modal.appendChild(em); } else { Object.keys(grouped).sort().forEach(letter=>{ const gh = document.createElement('div'); gh.className='group-header'; gh.textContent = letter; modal.appendChild(gh); const gl = document.createElement('div'); gl.className='group-list'; Object.keys(grouped[letter]).sort().forEach(cat=>{ const h = document.createElement('div'); h.className='muted'; h.textContent = cat; gl.appendChild(h); const arr = grouped[letter][cat]||[]; if (arr.length===0){ const n = document.createElement('div'); n.className='muted'; n.textContent='No favorites'; gl.appendChild(n); } else { arr.forEach(item=>{ const ni = document.createElement('div'); ni.className='group-item'; ni.innerHTML = '<strong>'+escapeHtml(item.verse)+'</strong><div class="muted" style="margin-top:6px">'+escapeHtml(item.text)+'</div>'; gl.appendChild(ni); }); } }); modal.appendChild(gl); }); }
      const row = document.createElement('div'); row.className = 'row'; const close = document.createElement('button'); close.className = 'btn'; close.textContent = 'Close'; row.appendChild(close); modal.appendChild(row); backdrop.appendChild(modal); root.appendChild(backdrop);
      function closeModal(){ root.innerHTML=''; favoritesModalOpen = false; favoritesToggle.classList.remove('active'); restoreBtn.style.display = 'none'; backBtn.style.display = 'none'; updatePanelCounts(); }
      close.addEventListener('click', closeModal);
      backdrop.addEventListener('click', (ev)=>{ if (ev.target===backdrop) closeModal(); });
    }

    // gather notes grouped
    function gatherAllNotes(){ const grouped = {}; Object.keys(notes||{}).forEach(catKey=>{ const [lettr, em] = catKey.split('|'); grouped[lettr] = grouped[lettr] || {}; grouped[lettr][em] = notes[catKey]; }); return grouped; }

    function openAllNotesModal(){ const root = document.getElementById('modalRoot'); root.innerHTML = ''; const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop'; backdrop.tabIndex = -1; const modal = document.createElement('div'); modal.className = 'modal'; const title = document.createElement('h3'); title.textContent = 'All Notes'; modal.appendChild(title);
      const grouped = gatherAllNotes(); if (Object.keys(grouped).length===0){ const em = document.createElement('div'); em.className='muted'; em.textContent='No notes yet.'; modal.appendChild(em); } else { Object.keys(grouped).sort().forEach(letter=>{ const gh = document.createElement('div'); gh.className='group-header'; gh.textContent = letter; modal.appendChild(gh); const gl = document.createElement('div'); gl.className='group-list'; Object.keys(grouped[letter]).sort().forEach(cat=>{ const h = document.createElement('div'); h.className='muted'; h.textContent = cat; gl.appendChild(h); const arr = grouped[letter][cat]||[]; if (arr.length===0){ const n = document.createElement('div'); n.className='muted'; n.textContent='No notes'; gl.appendChild(n); } else { arr.forEach(n=>{ const ni = document.createElement('div'); ni.className='group-item'; ni.textContent = (new Date(n.ts)).toLocaleString() + ' — ' + n.text; gl.appendChild(ni); }); } }); modal.appendChild(gl); }); }
      const row = document.createElement('div'); row.className = 'row'; const close = document.createElement('button'); close.className = 'btn'; close.textContent = 'Close'; row.appendChild(close); modal.appendChild(row); backdrop.appendChild(modal); root.appendChild(backdrop);
      function closeModal(){ root.innerHTML=''; updatePanelCounts(); }
      close.addEventListener('click', closeModal);
      backdrop.addEventListener('click', (ev)=>{ if (ev.target===backdrop) closeModal(); });
    }

    function updatePanelCounts(){ const k = makeCategoryKey(letterSelect.value||'', emotionSelect.value||''); const noteCountForCategory = (()=>{ if (!letterSelect.value || !emotionSelect.value) { // count all notes when nothing selected
          return Object.keys(notes||{}).reduce((sum, key)=> sum + ((notes[key] && notes[key].length) || 0), 0);
        } return notes[k] ? notes[k].length : 0; })(); notesBtn.textContent = `Notes (${noteCountForCategory})`; favoritesToggle.textContent = `Favorites (${favs.length||0})`; // panelCounts disabled per request — do not set text content
    } 

    /* -------------------- event handlers -------------------- */
    // Notes button handler: per-category when selected, otherwise show all notes
    notesBtn.addEventListener('click', () => {
      const letter = letterSelect.value;
      const emotion = emotionSelect.value;
      console.log('KNOCK DEBUG — notesBtn click', { letter, emotion });
      if (!letter || !emotion) {
        openAllNotesModal();
        return;
      }
      openNotesModal(letter, emotion);
    });

    // open notes modal for a specific letter+emotion (allows add/edit)
    function openNotesModal(letter, emotion){
      const catKey = makeCategoryKey(letter, emotion);
      const root = document.getElementById('modalRoot'); root.innerHTML = '';
      const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop'; backdrop.tabIndex = -1;
      const modal = document.createElement('div'); modal.className = 'modal';
      const title = document.createElement('h3'); title.textContent = `${letter} — ${emotion} notes`; modal.appendChild(title);
      const list = document.createElement('div'); modal.appendChild(list);
      const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Add note'; modal.appendChild(addBtn);
      const row = document.createElement('div'); row.className='row'; const close = document.createElement('button'); close.className='btn'; close.textContent='Close'; row.appendChild(close); modal.appendChild(row);
      backdrop.appendChild(modal); root.appendChild(backdrop);

      function renderList(){
        list.innerHTML = '';
        const existing = notes[catKey] || [];
        if (existing.length===0){ const em = document.createElement('div'); em.className='muted'; em.textContent='No notes yet.'; list.appendChild(em); }
        else{
          existing.forEach((n, idx)=>{
            const ni = document.createElement('div'); ni.className='note-item';
            const txt = document.createElement('div'); txt.className='note-text'; txt.textContent = (new Date(n.ts)).toLocaleString() + ' — ' + n.text;
            const controls = document.createElement('div');
            const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 21l3-1 11-11 1-3-3 1L4 20l-1 1z" fill="currentColor"/></svg> Edit';
            controls.appendChild(editBtn);
            ni.appendChild(txt); ni.appendChild(controls); list.appendChild(ni);
            editBtn.addEventListener('click', ()=>{
              const editor = document.createElement('div'); const ta = document.createElement('textarea'); ta.value = n.text; ta.style.marginBottom='8px';
              const erow = document.createElement('div'); erow.className='row'; const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Save'; const cancelBtn = document.createElement('button'); cancelBtn.className='btn'; cancelBtn.textContent='Cancel'; erow.appendChild(cancelBtn); erow.appendChild(saveBtn);
              editor.appendChild(ta); editor.appendChild(erow); ni.innerHTML = ''; ni.appendChild(editor); ta.focus();
              cancelBtn.addEventListener('click', ()=>{ renderList(); });
              saveBtn.addEventListener('click', ()=>{ const text = ta.value && ta.value.trim(); if (!text) return alert('Please write a note'); notes[catKey][idx].text = text; notes[catKey][idx].ts = Date.now(); saveNotes(); renderList(); updatePanelCounts(); });
            });
          });
        }
      }

      renderList();

      addBtn.addEventListener('click', ()=>{
        addBtn.style.display='none'; const editor = document.createElement('div'); const ta = document.createElement('textarea'); ta.placeholder='Write a short note...';
        const erow = document.createElement('div'); erow.className='row'; const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Save'; const cancelBtn = document.createElement('button'); cancelBtn.className='btn'; cancelBtn.textContent='Cancel'; erow.appendChild(cancelBtn); erow.appendChild(saveBtn);
        editor.appendChild(ta); editor.appendChild(erow); modal.appendChild(editor); ta.focus();
        cancelBtn.addEventListener('click', ()=>{ editor.remove(); addBtn.style.display='inline-block'; });
        saveBtn.addEventListener('click', ()=>{ const text = ta.value && ta.value.trim(); if (!text) return alert('Please write a note'); notes[catKey] = notes[catKey] || []; notes[catKey].push({text, ts: Date.now()}); saveNotes(); editor.remove(); addBtn.style.display='inline-block'; renderList(); updatePanelCounts(); });
      });

      function closeModal(){ root.innerHTML=''; updatePanelCounts(); }
      close.addEventListener('click', closeModal);
      backdrop.addEventListener('click', (ev)=>{ if (ev.target===backdrop) closeModal(); });
      document.addEventListener('keydown', function esc(e){ if (e.key==='Escape'){ closeModal(); document.removeEventListener('keydown', esc); } });
    }

    
    // initialize state from storage
    favs = loadFavs();
    notes = loadNotes();
    updatePanelCounts();

    letterSelect.addEventListener('change', (e) => {
      const letter = e.target.value;
      emotionSelect.innerHTML = '';
      const placeholder = document.createElement('option'); placeholder.value = ''; placeholder.textContent = letter ? '-- Select a Category --' : '-- pick a letter first --'; emotionSelect.appendChild(placeholder);
      if (!letter || !DATA[letter] || Object.keys(DATA[letter]).length === 0) { emotionSelect.disabled = true; renderMessage(letter ? 'No emotions available for this letter yet.' : 'Choose a letter.'); return; }
      Object.keys(DATA[letter]).sort().forEach(em => { const opt = document.createElement('option'); opt.value = em; opt.textContent = em + ' (' + (DATA[letter][em].length||0) + ')'; emotionSelect.appendChild(opt); });
      emotionSelect.disabled = false; renderMessage('Choose an emotion to see scriptures.');
    });

    emotionSelect.addEventListener('change', (e) => { const emotion = e.target.value; const letter = letterSelect.value; if (!letter || !emotion || !DATA[letter] || !DATA[letter][emotion]) { renderMessage('No scriptures yet.'); return; } currentItems = DATA[letter][emotion].map(item => ({...item, _letter: letter, _emotion: emotion})); favoritesView = false; favoritesToggle.classList.remove('active'); visibleCount = PER_PAGE; renderCards(); updatePanelCounts(); });

    favoritesToggle.addEventListener('click', () => {
      if (!favoritesView) {
        prevState = { letter: letterSelect.value, emotion: emotionSelect.value, visibleCount };
        // if nothing is selected, open grouped favorites modal
        if (!letterSelect.value && !emotionSelect.value) {
          favoritesModalOpen = true;
          favoritesToggle.classList.add('active');
          // modal flow relies on backdrop/close; do not show restore control
          restoreBtn.style.display = 'none';
          openAllFavoritesModal();
          // do not enter flat favorites view
          favoritesView = false;
          return;
        }
        // otherwise keep standard behavior (flat list)
        currentItems = getAllFavItems();
        favoritesView = true;
        favoritesToggle.classList.add('active');
        // show the subtle restore control only if prevState is meaningful
        if (prevState && (prevState.letter !== '' || prevState.emotion !== '')) {
          restoreBtn.style.display = 'inline-block';
        } else {
          restoreBtn.style.display = 'none';
        }
        visibleCount = currentItems.length; renderCards(true);
      } else {
        // turning favorites off: if modal was open, close it
        if (favoritesModalOpen) {
          const root = document.getElementById('modalRoot'); root.innerHTML = '';
          favoritesModalOpen = false;
          favoritesToggle.classList.remove('active'); restoreBtn.style.display = 'none'; backBtn.style.display = 'none';
          return;
        }
        favoritesView = false; favoritesToggle.classList.remove('active'); restoreBtn.style.display = 'none'; backBtn.style.display = 'none';
        if (prevState && (prevState.letter !== '' || prevState.emotion !== '')) {
          letterSelect.value = prevState.letter; letterSelect.dispatchEvent(new Event('change'));
          if (prevState.emotion) { setTimeout(()=>{ emotionSelect.value = prevState.emotion; emotionSelect.dispatchEvent(new Event('change')); visibleCount = prevState.visibleCount || PER_PAGE; }, 0); }
          else { visibleCount = prevState.visibleCount || PER_PAGE; renderMessage('Choose an emotion to see scriptures.'); }
        } else { renderMessage('Choose a letter and emotion to view verses.'); }
      }
    });

    // Restore button handler: restores previous selection when in flat favorites view
    restoreBtn.addEventListener('click', () => {
      if (favoritesModalOpen) return; // ignore when modal open
      if (favoritesView && prevState && (prevState.letter !== '' || prevState.emotion !== '')) {
        favoritesView = false; favoritesToggle.classList.remove('active'); restoreBtn.style.display = 'none';
        letterSelect.value = prevState.letter; letterSelect.dispatchEvent(new Event('change'));
        if (prevState.emotion) { setTimeout(()=>{ emotionSelect.value = prevState.emotion; emotionSelect.dispatchEvent(new Event('change')); visibleCount = prevState.visibleCount || PER_PAGE; }, 0); }
        else { visibleCount = prevState.visibleCount || PER_PAGE; renderMessage('Choose an emotion to see scriptures.'); }
      }
    });

    // Back button handler retained but subtler — used as an extra close in some flows
    backBtn.addEventListener('click', () => {
      // if grouped favorites modal is open, close it
      if (favoritesModalOpen) {
        const root = document.getElementById('modalRoot'); root.innerHTML = '';
        favoritesModalOpen = false;
        favoritesToggle.classList.remove('active');
        backBtn.style.display = 'none';
        restoreBtn.style.display = 'none';
        updatePanelCounts();
        return;
      }

      // if in flat favorites view, restore prevState or just turn off favorites
      if (favoritesView) {
        favoritesView = false; favoritesToggle.classList.remove('active'); restoreBtn.style.display = 'none';
        if (prevState && (prevState.letter !== '' || prevState.emotion !== '')) {
          letterSelect.value = prevState.letter; letterSelect.dispatchEvent(new Event('change'));
          if (prevState.emotion) { setTimeout(()=>{ emotionSelect.value = prevState.emotion; emotionSelect.dispatchEvent(new Event('change')); visibleCount = prevState.visibleCount || PER_PAGE; }, 0); }
          else { visibleCount = prevState.visibleCount || PER_PAGE; renderMessage('Choose an emotion to see scriptures.'); }
        } else {
          renderMessage('Choose a letter and emotion to view verses.');
        }
        backBtn.style.display = 'none';
        updatePanelCounts();
        return;
      }
    });

    function renderCards(animate=false){ scriptures.innerHTML = ''; const toShow = currentItems.slice(0, visibleCount); toShow.forEach((it, idx) => { const card = document.createElement('div'); card.className = 'card'; const v = document.createElement('strong'); v.textContent = it.verse; const p = document.createElement('p'); p.textContent = it.text; const actions = document.createElement('div'); actions.className = 'actions'; const favBtn = document.createElement('button'); favBtn.className = 'icon-btn heart'; favBtn.setAttribute('aria-label','Favorite'); const key = makeKey(it._letter||'', it._emotion||'', it.verse); favBtn.innerHTML = favs.includes(key) ? '♥' : '♡'; favBtn.setAttribute('aria-pressed', favs.includes(key)); favBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); toggleFav(key); favBtn.innerHTML = favs.includes(key) ? '♥' : '♡'; favBtn.setAttribute('aria-pressed', favs.includes(key)); updatePanelCounts(); }); actions.appendChild(favBtn); card.appendChild(actions); card.appendChild(v); card.appendChild(p); scriptures.appendChild(card); if (animate) requestAnimationFrame(()=>{ card.classList.add('enter'); }); else setTimeout(()=>{ card.classList.add('enter'); }, idx*30); }); if (currentItems.length > PER_PAGE) { showMoreBtn.style.display = 'inline-block'; showMoreBtn.textContent = visibleCount >= currentItems.length ? 'Show less' : 'Show more'; } else { showMoreBtn.style.display = 'none'; } updatePanelCounts(); }

    function loadFavs(){ try{ const raw = JSON.parse(localStorage.getItem(STORAGE_FAVS))||[]; const valid = raw.filter(k => existsInDataKey(k)); if (valid.length !== raw.length) { localStorage.setItem(STORAGE_FAVS, JSON.stringify(valid)); } return valid; }catch(e){return[]} }
    function saveFavs(){ localStorage.setItem(STORAGE_FAVS, JSON.stringify(favs)); }
    function toggleFav(key){ if (!existsInDataKey(key)) return; const i = favs.indexOf(key); if (i>-1) { favs.splice(i,1); } else { favs.push(key); } saveFavs(); }
    function loadNotes(){ try{ return JSON.parse(localStorage.getItem(STORAGE_NOTES))||{} }catch(e){return{}} }
    function saveNotes(){ localStorage.setItem(STORAGE_NOTES, JSON.stringify(notes)); }
    function makeKey(letter, emotion, verse){ return [letter, emotion, verse].join('|'); }
    function makeCategoryKey(letter, emotion){ return [letter, emotion].join('|'); }
    function getAllFavItems(){ const rows = []; Object.keys(DATA).forEach(letter=>{ Object.keys(DATA[letter]).forEach(em=>{ DATA[letter][em].forEach(item=>{ const key = makeKey(letter, em, item.verse); if (favs.includes(key)) rows.push({...item, _letter: letter, _emotion: em}); }); }); }); return rows; }

    // gather all notes grouped by letter->emotion
    function gatherAllNotes(){ const grouped = {}; Object.keys(notes||{}).forEach(catKey=>{ const [lettr, em] = catKey.split('|'); grouped[lettr] = grouped[lettr] || {}; grouped[lettr][em] = notes[catKey]; }); return grouped; }

    // gather all favorites grouped by letter->emotion (used by grouped modal)
    function gatherAllFavorites(){ const grouped = {}; (favs||[]).forEach(key=>{ if (!existsInDataKey(key)) return; const parts = key.split('|'); const letter = parts[0] || ''; const em = parts[1] || ''; const verse = parts.slice(2).join('|') || ''; if (!letter) return; grouped[letter] = grouped[letter] || {}; grouped[letter][em] = grouped[letter][em] || []; const item = (DATA[letter] && DATA[letter][em] && DATA[letter][em].find(it => it.verse === verse)); if (item) grouped[letter][em].push(item); }); return grouped; }

    // open grouped favorites modal (defined to prevent ReferenceError)
    function openAllFavoritesModal(){ const root = document.getElementById('modalRoot'); root.innerHTML = ''; const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop'; backdrop.tabIndex = -1; const modal = document.createElement('div'); modal.className = 'modal'; const title = document.createElement('h3'); title.textContent = 'All Favorites'; modal.appendChild(title);
      const grouped = gatherAllFavorites(); if (Object.keys(grouped).length===0){ const em = document.createElement('div'); em.className='muted'; em.textContent='No favorites yet.'; modal.appendChild(em); } else { Object.keys(grouped).sort().forEach(letter=>{ const gh = document.createElement('div'); gh.className='group-header'; gh.textContent = letter; modal.appendChild(gh); const gl = document.createElement('div'); gl.className='group-list'; Object.keys(grouped[letter]).sort().forEach(cat=>{ const h = document.createElement('div'); h.className='muted'; h.textContent = cat; gl.appendChild(h); const arr = grouped[letter][cat]||[]; if (arr.length===0){ const n = document.createElement('div'); n.className='muted'; n.textContent='No favorites'; gl.appendChild(n); } else { arr.forEach(item=>{ const ni = document.createElement('div'); ni.className='group-item'; ni.innerHTML = '<strong>'+escapeHtml(item.verse)+'</strong><div class="muted" style="margin-top:6px">'+escapeHtml(item.text)+'</div>'; gl.appendChild(ni); }); } }); modal.appendChild(gl); }); }
      const row = document.createElement('div'); row.className='row'; const close = document.createElement('button'); close.className='btn'; close.textContent = 'Close'; row.appendChild(close); modal.appendChild(row); backdrop.appendChild(modal); root.appendChild(backdrop);
      function closeModal(){ root.innerHTML=''; favoritesModalOpen = false; favoritesToggle.classList.remove('active'); backBtn.style.display = 'none'; updatePanelCounts(); }
      close.addEventListener('click', closeModal);
      backdrop.addEventListener('click', (ev)=>{ if (ev.target===backdrop) closeModal(); });
    }

    function openAllNotesModal(){ const root = document.getElementById('modalRoot'); root.innerHTML = ''; const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop'; backdrop.tabIndex = -1; const modal = document.createElement('div'); modal.className = 'modal'; const title = document.createElement('h3'); title.textContent = 'All Notes'; modal.appendChild(title);
      const grouped = gatherAllNotes(); if (Object.keys(grouped).length===0){ const em = document.createElement('div'); em.className='muted'; em.textContent='No notes yet.'; modal.appendChild(em); } else { Object.keys(grouped).sort().forEach(letter=>{ const gh = document.createElement('div'); gh.className='group-header'; gh.textContent = letter; modal.appendChild(gh); const gl = document.createElement('div'); gl.className='group-list'; Object.keys(grouped[letter]).sort().forEach(cat=>{ const h = document.createElement('div'); h.className='muted'; h.textContent = cat; gl.appendChild(h); const arr = grouped[letter][cat]||[]; if (arr.length===0){ const n = document.createElement('div'); n.className='muted'; n.textContent='No notes'; gl.appendChild(n); } else { arr.forEach(n=>{ const ni = document.createElement('div'); ni.className='group-item'; ni.textContent = (new Date(n.ts)).toLocaleString() + ' — ' + n.text; gl.appendChild(ni); }); } }); modal.appendChild(gl); }); }
      const row = document.createElement('div'); row.className = 'row'; const close = document.createElement('button'); close.className = 'btn'; close.textContent = 'Close'; row.appendChild(close); modal.appendChild(row); backdrop.appendChild(modal); root.appendChild(backdrop);
      function closeModal(){ root.innerHTML=''; updatePanelCounts(); }
      close.addEventListener('click', closeModal);
      backdrop.addEventListener('click', (ev)=>{ if (ev.target===backdrop) closeModal(); });
    }

    function updatePanelCounts(){ const k = makeCategoryKey(letterSelect.value||'', emotionSelect.value||''); const noteCountForCategory = (()=>{ if (!letterSelect.value || !emotionSelect.value) { // count all notes when nothing selected
          return Object.keys(notes||{}).reduce((sum, key)=> sum + ((notes[key] && notes[key].length) || 0), 0);
        } return notes[k] ? notes[k].length : 0; })(); notesBtn.textContent = `Notes (${noteCountForCategory})`; favoritesToggle.textContent = `Favorites (${favs.length||0})`; panelCounts.textContent = (noteCountForCategory? noteCountForCategory+' notes':'' ); }

    function existsInDataKey(key){ if (!key) return false; const parts = key.split('|'); const letter = parts[0] || ''; const emotion = parts[1] || ''; const verse = parts.slice(2).join('|') || ''; return !!(DATA[letter] && DATA[letter][emotion] && DATA[letter][emotion].some(item => item.verse === verse)); }

    function openNotesModal(letter, emotion){ const catKey = makeCategoryKey(letter, emotion); const root = document.getElementById('modalRoot'); root.innerHTML = ''; const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop'; backdrop.tabIndex = -1; const modal = document.createElement('div'); modal.className = 'modal'; const title = document.createElement('h3'); title.textContent = `${letter} — ${emotion} notes`; modal.appendChild(title); const list = document.createElement('div'); modal.appendChild(list); const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Add note'; modal.appendChild(addBtn); const row = document.createElement('div'); row.className = 'row'; const close = document.createElement('button'); close.className = 'btn'; close.textContent = 'Close'; row.appendChild(close); modal.appendChild(row); backdrop.appendChild(modal); root.appendChild(backdrop); function renderList(){ list.innerHTML = ''; const existing = notes[catKey] || []; if (existing.length===0){ const em = document.createElement('div'); em.className='muted'; em.textContent='No notes yet.'; list.appendChild(em); } else{ existing.forEach((n, idx)=>{ const ni = document.createElement('div'); ni.className='note-item'; const txt = document.createElement('div'); txt.className='note-text'; txt.textContent = (new Date(n.ts)).toLocaleString() + ' — ' + n.text; const controls = document.createElement('div'); const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 21l3-1 11-11 1-3-3 1L4 20l-1 1z" fill="currentColor"/></svg> Edit'; controls.appendChild(editBtn); ni.appendChild(txt); ni.appendChild(controls); list.appendChild(ni); editBtn.addEventListener('click', ()=>{ const editor = document.createElement('div'); const ta = document.createElement('textarea'); ta.value = n.text; ta.style.marginBottom='8px'; const erow = document.createElement('div'); erow.className='row'; const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Save'; const cancelBtn = document.createElement('button'); cancelBtn.className='btn'; cancelBtn.textContent='Cancel'; erow.appendChild(cancelBtn); erow.appendChild(saveBtn); editor.appendChild(ta); editor.appendChild(erow); ni.innerHTML = ''; ni.appendChild(editor); ta.focus(); cancelBtn.addEventListener('click', ()=>{ renderList(); }); saveBtn.addEventListener('click', ()=>{ const text = ta.value && ta.value.trim(); if (!text) return alert('Please write a note'); notes[catKey][idx].text = text; notes[catKey][idx].ts = Date.now(); saveNotes(); renderList(); updatePanelCounts(); }); }); }); } } renderList(); addBtn.addEventListener('click', ()=>{ addBtn.style.display='none'; const editor = document.createElement('div'); const ta = document.createElement('textarea'); ta.placeholder='Write a short note...'; const erow = document.createElement('div'); erow.className='row'; const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Save'; const cancelBtn = document.createElement('button'); cancelBtn.className='btn'; cancelBtn.textContent='Cancel'; erow.appendChild(cancelBtn); erow.appendChild(saveBtn); editor.appendChild(ta); editor.appendChild(erow); modal.appendChild(editor); ta.focus(); cancelBtn.addEventListener('click', ()=>{ editor.remove(); addBtn.style.display='inline-block'; }); saveBtn.addEventListener('click', ()=>{ const text = ta.value && ta.value.trim(); if (!text) return alert('Please write a note'); notes[catKey] = notes[catKey] || []; notes[catKey].push({text, ts: Date.now()}); saveNotes(); editor.remove(); addBtn.style.display='inline-block'; renderList(); updatePanelCounts(); }); }); function closeModal(){ root.innerHTML=''; updatePanelCounts(); } close.addEventListener('click', closeModal); backdrop.addEventListener('click', (ev)=>{ if (ev.target===backdrop) closeModal(); }); document.addEventListener('keydown', function esc(e){ if (e.key==='Escape'){ closeModal(); document.removeEventListener('keydown', esc); } }); }
    renderMessage('Choose a letter and emotion to view verses.');
  </script>
</body>
</html>
