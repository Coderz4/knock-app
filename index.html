<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KNOCK — Prototype — Compact letter pill (panel) — with demo data (restore)</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;padding:28px;background:#f6f7fb;color:#111}
    .wrap{max-width:640px;margin:0 auto}
    .panel{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:#fff;box-shadow:0 6px 18px rgba(22,28,45,0.06)}
    .left{width:120px;display:flex;flex-direction:column;gap:6px}
    .label{font-size:12px;font-weight:600;color:#333}
    .letter-pill{padding:12px;border-radius:10px;border:1px solid #e6e6ea;background:#fff;font-size:18px}
    .divider{width:1px;height:44px;background:linear-gradient(#fff,#eee);margin-left:-6px;margin-right:6px}
    .right{flex:1;display:flex;flex-direction:column}
    .emotion-full{padding:12px;border-radius:10px;border:1px solid #e6e6ea;background:#fff;font-size:16px}

    /* controls */
    .controls-row{width:100%;max-width:640px;margin:12px auto 0;display:flex;justify-content:flex-end;gap:8px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #e6e6ea;background:#fff;font-size:14px;cursor:pointer}
    .btn.active{background:#f0f6ff;border-color:#cfe0ff}
    .back-btn{display:none}

    /* cards */
    .cards{width:100%;max-width:640px;margin:12px auto 0;display:flex;flex-direction:column;gap:12px}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 8px 20px rgba(22,28,45,0.06);border:1px solid rgba(0,0,0,0.04);position:relative;opacity:0;transform:translateY(10px)}
    .card.enter{opacity:1;transform:none;transition:opacity 140ms ease, transform 140ms ease}
    .card strong{display:block;font-size:18px;margin-bottom:6px}
    .card p{margin:0;font-size:15px;color:#333;line-height:1.4}

    .card .actions{position:absolute;top:12px;right:12px;display:flex;gap:8px}
    .icon-btn{background:transparent;border:0;padding:6px;border-radius:8px;cursor:pointer;font-size:16px}
    .icon-btn.heart[aria-pressed="true"]{color:#e0245e}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(10,12,16,0.4);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:#fff;padding:16px;border-radius:12px;box-shadow:0 20px 60px rgba(22,28,45,0.2);max-width:520px;width:100%}
    .modal h3{margin:0 0 10px 0;font-size:18px}
    .modal textarea{width:100%;min-height:90px;padding:10px;font-size:15px;border-radius:8px;border:1px solid #e6e6ea}
    .modal .row{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .note-item{padding:8px;border-radius:8px;border:1px solid #eef2f6;background:#fbfdff;margin-bottom:8px}
    .muted{color:#666;font-size:13px}

    @media (max-width:520px){
      .panel{flex-direction:column;gap:10px}
      .divider{display:none}
      .left{width:100%}
      .wrap{padding:12px}
      .controls-row{justify-content:center}
      .modal{margin:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:0 0 12px 0;font-size:18px;text-align:center">KNOCK — Compact letter pill (panel)</h2>

    <div class="panel">
      <div class="left">
        <div class="label">Letter</div>
        <select id="letterSelect" class="letter-pill" aria-label="Select letter">
          <option value="">--</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>

      <div class="divider" aria-hidden="true"></div>

      <div class="right" style="position:relative">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div class="label">Emotion</div>
          <div id="panelCounts" class="muted"></div>
        </div>
        <select id="emotionSelect" class="emotion-full" aria-label="Select emotion" disabled>
          <option value="">-- pick a letter first --</option>
        </select>
      </div>
    </div>

    <div class="controls-row">
      <button id="notesBtn" class="btn" title="Notes">Notes (0)</button>
      <button id="favoritesToggle" class="btn" title="Show favorites">Favorites (0)</button>
      <button id="backBtn" class="btn back-btn">Back</button>
      <button id="showMoreBtn" class="btn" style="display:none">Show more</button>
    </div>

    <div id="scriptures" class="cards" aria-live="polite">
      <em style="margin-top:14px;display:block;text-align:center;color:#666">Choose a letter and emotion to view verses.</em>
    </div>
  </div>

  <!-- modal placeholder -->
  <div id="modalRoot"></div>

  <script>
    const PER_PAGE = 6;
    const STORAGE_FAVS = 'knock_favs_v1';
    const STORAGE_NOTES = 'knock_notes_v1';

    const DATA = {
      A: {
        Anxiety: [
          {verse: "Philippians 4:6-7", text: "Do not be anxious about anything; pray and present your requests to God."},
          {verse: "1 Peter 5:7", text: "Cast all your anxiety on him because he cares for you."},
          {verse: "Matthew 6:34", text: "Do not worry about tomorrow, for tomorrow will worry about itself."},
          {verse: "Psalm 55:22", text: "Cast your burden on the LORD, and he will sustain you."},
          {verse: "Isaiah 41:10", text: "Fear not, for I am with you; be not dismayed, for I am your God."},
          {verse: "John 14:27", text: "Peace I leave with you; my peace I give to you."},
          {verse: "Psalm 34:4", text: "I sought the LORD, and he answered me and delivered me from all my fears."}
        ],
        Anger: [
          {verse: "Ephesians 4:26", text: "In your anger do not sin."},
          {verse: "James 1:19-20", text: "Be quick to hear, slow to speak, slow to anger."},
          {verse: "Proverbs 15:1", text: "A soft answer turns away wrath, but a harsh word stirs up anger."}
        ]
      },
      B: {
        Bitterness: [
          {verse: "Hebrews 12:15", text: "See to it that no bitter root grows up to cause trouble."},
          {verse: "Ephesians 4:31-32", text: "Put away bitterness and be kind to one another."}
        ]
      },
      C: {
        Confusion: [
          {verse: "Proverbs 3:5", text: "Trust in the LORD with all your heart and do not rely on your own understanding."},
          {verse: "Isaiah 55:8-9", text: "My thoughts are not your thoughts, neither are your ways my ways, declares the LORD."}
        ]
      }
    };

    // state
    let favs = loadFavs(); // array of keys
    let notes = loadNotes(); // {categoryKey: [ {text, ts} ] }
    let favoritesView = false;
    let prevState = null; // {letter, emotion}
    let currentItems = [];
    let visibleCount = PER_PAGE;

    const letterSelect = document.getElementById('letterSelect');
    const emotionSelect = document.getElementById('emotionSelect');
    const scriptures = document.getElementById('scriptures');
    const favoritesToggle = document.getElementById('favoritesToggle');
    const notesBtn = document.getElementById('notesBtn');
    const backBtn = document.getElementById('backBtn');
    const panelCounts = document.getElementById('panelCounts');
    const showMoreBtn = document.getElementById('showMoreBtn');

    updatePanelCounts();

    letterSelect.addEventListener('change', (e) => {
      const letter = e.target.value;
      emotionSelect.innerHTML = '';
      const placeholder = document.createElement('option'); placeholder.value = ''; placeholder.textContent = letter ? '-- select emotion --' : '-- pick a letter first --'; emotionSelect.appendChild(placeholder);

      if (!letter || !DATA[letter] || Object.keys(DATA[letter]).length === 0) {
        emotionSelect.disabled = true;
        renderMessage(letter ? 'No emotions available for this letter yet.' : 'Choose a letter.');
        return;
      }

      Object.keys(DATA[letter]).sort().forEach(em => {
        const opt = document.createElement('option'); opt.value = em; opt.textContent = em + ' (' + (DATA[letter][em].length||0) + ')'; emotionSelect.appendChild(opt);
      });

      emotionSelect.disabled = false;
      renderMessage('Choose an emotion to see scriptures.');
    });

    emotionSelect.addEventListener('change', (e) => {
      const emotion = e.target.value; const letter = letterSelect.value;
      if (!letter || !emotion || !DATA[letter] || !DATA[letter][emotion]) { renderMessage('No scriptures yet.'); return; }
      currentItems = DATA[letter][emotion].map(item => ({...item, _letter: letter, _emotion: emotion}));
      favoritesView = false; favoritesToggle.classList.remove('active');
      visibleCount = PER_PAGE;
      renderCards();
      updatePanelCounts();
    });

    favoritesToggle.addEventListener('click', () => {
      if (!favoritesView) {
        // entering favorites - save previous state so we can go back
        prevState = { letter: letterSelect.value, emotion: emotionSelect.value, visibleCount };
        currentItems = getAllFavItems();
        favoritesView = true;
        favoritesToggle.classList.add('active');
        backBtn.style.display = 'inline-block';
        visibleCount = currentItems.length;
        renderCards(true);
      } else {
        // exiting favorites - restore
        favoritesView = false;
        favoritesToggle.classList.remove('active');
        backBtn.style.display = 'none';
        if (prevState && prevState.letter) {
          letterSelect.value = prevState.letter;
          // trigger change to repopulate emotions
          letterSelect.dispatchEvent(new Event('change'));
          if (prevState.emotion) {
            setTimeout(()=>{ emotionSelect.value = prevState.emotion; emotionSelect.dispatchEvent(new Event('change')); visibleCount = prevState.visibleCount || PER_PAGE; }, 0);
          } else {
            visibleCount = prevState.visibleCount || PER_PAGE;
            renderMessage('Choose an emotion to see scriptures.');
          }
        } else {
          renderMessage('Choose a letter and emotion to view verses.');
        }
      }
    });

    backBtn.addEventListener('click', ()=>{
      // restore previous
      favoritesToggle.click();
    });

    notesBtn.addEventListener('click', ()=>{
      const letter = letterSelect.value; const emotion = emotionSelect.value;
      if (!letter || !emotion) { alert('Select a letter and emotion first to view notes for that category.'); return; }
      openNotesModal(letter, emotion);
    });

    showMoreBtn.addEventListener('click', ()=>{
      if (visibleCount >= currentItems.length) { visibleCount = PER_PAGE; showMoreBtn.textContent = 'Show more'; }
      else { visibleCount = currentItems.length; showMoreBtn.textContent = 'Show less'; }
      renderCards(true);
    });

    function renderMessage(msg){ scriptures.innerHTML = '<em style="text-align:center;color:#666">'+escapeHtml(msg)+'</em>'; showMoreBtn.style.display='none'; }

    function renderCards(animate=false){
      scriptures.innerHTML = '';
      const toShow = currentItems.slice(0, visibleCount);
      toShow.forEach((it, idx) => {
        const card = document.createElement('div'); card.className = 'card';
        const v = document.createElement('strong'); v.textContent = it.verse;
        const p = document.createElement('p'); p.textContent = it.text;

        // actions (heart only)
        const actions = document.createElement('div'); actions.className = 'actions';
        const favBtn = document.createElement('button'); favBtn.className = 'icon-btn heart'; favBtn.setAttribute('aria-label','Favorite');
        const key = makeKey(it._letter||'', it._emotion||'', it.verse);
        favBtn.innerHTML = favs.includes(key) ? '♥' : '♡';
        favBtn.setAttribute('aria-pressed', favs.includes(key));
        favBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); toggleFav(key); favBtn.innerHTML = favs.includes(key) ? '♥' : '♡'; favBtn.setAttribute('aria-pressed', favs.includes(key)); updatePanelCounts(); });

        actions.appendChild(favBtn);
        card.appendChild(actions);
        card.appendChild(v); card.appendChild(p);

        scriptures.appendChild(card);
        if (animate) requestAnimationFrame(()=>{ card.classList.add('enter'); }); else setTimeout(()=>{ card.classList.add('enter'); }, idx*30);
      });
      // show or hide button
      if (currentItems.length > PER_PAGE) { showMoreBtn.style.display = 'inline-block'; showMoreBtn.textContent = visibleCount >= currentItems.length ? 'Show less' : 'Show more'; }
      else { showMoreBtn.style.display = 'none'; }
      updatePanelCounts();
    }

    // favorites
    function loadFavs(){ try{ return JSON.parse(localStorage.getItem(STORAGE_FAVS))||[] }catch(e){return[]} }
    function saveFavs(){ localStorage.setItem(STORAGE_FAVS, JSON.stringify(favs)); }
    function toggleFav(key){ const i = favs.indexOf(key); if (i>-1) { favs.splice(i,1); } else { favs.push(key); } saveFavs(); }

    // notes
    function loadNotes(){ try{ return JSON.parse(localStorage.getItem(STORAGE_NOTES))||{} }catch(e){return{}} }
    function saveNotes(){ localStorage.setItem(STORAGE_NOTES, JSON.stringify(notes)); }

    function makeKey(letter, emotion, verse){ return [letter, emotion, verse].join('|'); }
    function makeCategoryKey(letter, emotion){ return [letter, emotion].join('|'); }

    function getAllFavItems(){
      const rows = [];
      Object.keys(DATA).forEach(letter=>{
        Object.keys(DATA[letter]).forEach(em=>{
          DATA[letter][em].forEach(item=>{
            const key = makeKey(letter, em, item.verse);
            if (favs.includes(key)) rows.push({...item, _letter: letter, _emotion: em});
          });
        });
      });
      return rows;
    }

    function updatePanelCounts(){
      const noteCountForCategory = (()=>{
        const k = makeCategoryKey(letterSelect.value||'', emotionSelect.value||'');
        return notes[k] ? notes[k].length : 0;
      })();
      notesBtn.textContent = `Notes (${noteCountForCategory})`;
      favoritesToggle.textContent = `Favorites (${favs.length||0})`;
      panelCounts.textContent = (noteCountForCategory? noteCountForCategory+' notes':'' );
    }

    // Notes modal (category-scoped)
    function openNotesModal(letter, emotion){
      const catKey = makeCategoryKey(letter, emotion);
      const root = document.getElementById('modalRoot'); root.innerHTML = '';
      const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop';
      backdrop.tabIndex = -1;

      const modal = document.createElement('div'); modal.className = 'modal';
      const title = document.createElement('h3'); title.textContent = `${letter} — ${emotion} notes`;
      modal.appendChild(title);

      const list = document.createElement('div');
      const existing = notes[catKey] || [];
      if (existing.length===0){ const em = document.createElement('div'); em.className='muted'; em.textContent='No notes yet.'; list.appendChild(em); }
      else{ existing.forEach(n=>{ const ni = document.createElement('div'); ni.className='note-item'; ni.textContent = (new Date(n.ts)).toLocaleString() + ' — ' + n.text; list.appendChild(ni); }); }
      modal.appendChild(list);

      const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='Add note';
      modal.appendChild(addBtn);

      const row = document.createElement('div'); row.className='row';
      const close = document.createElement('button'); close.className='btn'; close.textContent='Close';
      row.appendChild(close);
      modal.appendChild(row);

      backdrop.appendChild(modal); root.appendChild(backdrop);

      // add editor when requested
      addBtn.addEventListener('click', ()=>{
        addBtn.style.display='none';
        const editor = document.createElement('div');
        const ta = document.createElement('textarea'); ta.placeholder='Write a short note...';
        const erow = document.createElement('div'); erow.className='row';
        const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Save';
        const cancelBtn = document.createElement('button'); cancelBtn.className='btn'; cancelBtn.textContent='Cancel';
        erow.appendChild(cancelBtn); erow.appendChild(saveBtn);
        editor.appendChild(ta); editor.appendChild(erow);
        modal.appendChild(editor);
        ta.focus();

        cancelBtn.addEventListener('click', ()=>{ editor.remove(); addBtn.style.display='inline-block'; });
        saveBtn.addEventListener('click', ()=>{
          const text = ta.value && ta.value.trim(); if (!text) return alert('Please write a note');
          notes[catKey] = notes[catKey] || [];
          notes[catKey].push({text, ts: Date.now()}); saveNotes();
          closeModal();
          // reopen to show updated list
          setTimeout(()=> openNotesModal(letter, emotion), 50);
        });
      });

      function closeModal(){ root.innerHTML=''; updatePanelCounts(); }
      close.addEventListener('click', closeModal);
      backdrop.addEventListener('click', (ev)=>{ if (ev.target===backdrop) closeModal(); });
      document.addEventListener('keydown', function esc(e){ if (e.key==='Escape'){ closeModal(); document.removeEventListener('keydown', esc); } });
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

    // initial
    renderMessage('Choose a letter and emotion to view verses.');
  </script>
</body>
</html>
