<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emotional Bible Verse Browser — Enhanced</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  
  :root{
    --accent:#805E85;
    --accent-strong:#6b4c70;
    --accent-light:#9a7ba0;
    --bg-primary:#1a1625;
    --bg-secondary:#252033;
    --bg-tertiary:#2d2640;
    --card-bg:#312a45;
    --card-hover:#3a3352;
    --text-primary:#e8e6eb;
    --text-secondary:#b8b3c4;
    --text-muted:#8a8291;
    --tile-size: 64px;
    --border:#3d3650;
    --border-light:#4a445c;
    --shadow:0 8px 32px rgba(0,0,0,0.3);
    --shadow-lg:0 16px 64px rgba(0,0,0,0.4);
    --focus:0 0 0 3px rgba(128,94,133,0.4);
    --gradient:linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
    --gradient-card:linear-gradient(145deg, var(--card-bg) 0%, rgba(49,42,69,0.8) 100%);
  }
  
  *{box-sizing:border-box}
  
  body{
    margin:0;
    font-family:'Inter',system-ui,Arial;
    background:var(--bg-primary);
    color:var(--text-primary);
    line-height:1.6;
    transition:all 0.3s ease;
  }
  
  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:16px 24px;
    background:var(--bg-secondary);
    border-bottom:1px solid var(--border);
    backdrop-filter:blur(10px);
    position:sticky;
    top:0;
    z-index:100;
  }
  
  .logo{
    width:48px;
    height:48px;
    border-radius:12px;
    background:var(--gradient);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:700;
    font-size:18px;
    box-shadow:var(--shadow);
    transition:transform 0.2s ease;
  }
  
  .logo:hover{
    transform:scale(1.05);
  }
  
  .header-title{
    font-size:20px;
    font-weight:600;
    color:var(--text-primary);
  }
  
  .header-subtitle{
    font-size:14px;
    color:var(--text-muted);
    font-weight:400;
  }
  
  .header-buttons{
    display:flex;
    gap:12px;
  }
  
  .header-btn{
    background:var(--card-bg);
    color:var(--text-primary);
    border:1px solid var(--border);
    padding:10px 16px;
    border-radius:10px;
    cursor:pointer;
    font-weight:500;
    transition:all 0.2s ease;
    font-size:14px;
  }
  
  .header-btn:hover{
    background:var(--card-hover);
    border-color:var(--border-light);
    transform:translateY(-1px);
  }
  
  .header-btn:focus{
    outline:none;
    box-shadow:var(--focus);
  }
  
  main{
    padding:24px;
    max-width:1100px;
    margin:0 auto;
    min-height:calc(100vh - 80px);
  }
.letters-grid{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(var(--tile-size), 1fr));
  justify-items: center;    /* center each tile in its column */
  column-gap: 8px;          /* tighten horizontal spacing */
  row-gap: 10px;            /* vertical spacing */
  margin-top:16px;
  width:100%;
  max-width:100%;
}


  
  @media(min-width:720px){
    .letters-grid{
      grid-template-columns:repeat(8,1fr);
      gap:16px;
    }
  }
  
  @media(min-width:1024px){
    .letters-grid{
      grid-template-columns:repeat(10,1fr);
    }
  }
  
  .letter-card{
  width: var(--tile-size);
  height: var(--tile-size);
  padding: 0;               /* remove internal vertical padding */
  border-radius: 50%;       /* make circular */
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  color:var(--text-primary);
  cursor:pointer;
  box-shadow:var(--shadow);
  font-size:18px;           /* tweak as needed */
  transition:all 0.2s ease;
  position:relative;
  overflow:hidden;
  line-height:1;
}


  
  .letter-card::before{
    content:'';
    position:absolute;
    top:0;
    left:-100%;
    width:100%;
    height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition:left 0.5s ease;
  }
  
  .letter-card:hover{
    background:var(--card-hover);
    border-color:var(--accent-light);
    transform:translateY(-2px) scale(1.02);
    box-shadow:var(--shadow-lg);
  }
  
  .letter-card:hover::before{
    left:100%;
  }
  
  .letter-card:focus{
    outline:none;
    box-shadow:var(--focus), var(--shadow);
  }
  
  .panel{
    background:var(--gradient-card);
    padding:24px;
    border-radius:16px;
    box-shadow:var(--shadow);
    margin-bottom:20px;
    border:1px solid var(--border);
    backdrop-filter:blur(10px);
  }
  
  .panel-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
    padding-bottom:16px;
    border-bottom:1px solid var(--border);
  }
  
  .panel-title{
    font-size:18px;
    font-weight:600;
    color:var(--text-primary);
  }
  
  .list{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  
  .cat-item, .verse-item{
    padding:18px 20px;
    border-radius:12px;
    background:var(--bg-tertiary);
    border:1px solid var(--border);
    cursor:pointer;
    transition:all 0.2s ease;
    position:relative;
    overflow:visible;
  }
  
  .cat-item::before, .verse-item::before{
    content:'';
    position:absolute;
    left:0;
    top:0;
    width:4px;
    height:100%;
    background:var(--gradient);
    transform:scaleY(0);
    transition:transform 0.2s ease;
  }
  
  .cat-item:hover, .verse-item:hover{
    background:var(--card-hover);
    border-color:var(--border-light);
    transform:translateX(4px);
  }
  
  .cat-item:hover::before, .verse-item:hover::before{
    transform:scaleY(1);
  }
  
  .verse-ref{
    font-weight:600;
    color:var(--accent-light);
    font-size:15px;
  }
  
  .verse-text{
    color:var(--text-primary);
    margin-top:8px;
    line-height:1.6;
  }
  
  .btn{
    background:var(--gradient);
    color:#fff;
    border:0;
    padding:12px 20px;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
    transition:all 0.2s ease;
    font-size:14px;
    box-shadow:0 4px 16px rgba(128,94,133,0.3);
  }
  
  .btn:hover{
    transform:translateY(-2px);
    box-shadow:0 6px 24px rgba(128,94,133,0.4);
  }
  
  .btn:focus{
    outline:none;
    box-shadow:var(--focus);
  }
  
  .btn-secondary{
    background:var(--card-bg);
    color:var(--text-primary);
    border:1px solid var(--border);
    box-shadow:var(--shadow);
  }
  
  .btn-secondary:hover{
    background:var(--card-hover);
    border-color:var(--border-light);
  }
  
  .note-editor{
    width:100%;
    min-height:100px;
    padding:16px;
    border-radius:12px;
    border:1px solid var(--border);
    background:var(--bg-tertiary);
    color:var(--text-primary);
    font-family:inherit;
    font-size:14px;
    line-height:1.5;
    resize:vertical;
    transition:all 0.2s ease;
  }
  
  .note-editor:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:var(--focus);
  }
  
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    backdrop-filter:blur(8px);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:1000;
    animation:fadeIn 0.2s ease;
  }
  
  @keyframes fadeIn{
    from{opacity:0;}
    to{opacity:1;}
  }
  
  .modal{
    width:95%;
    max-width:680px;
    background:var(--gradient-card);
    border:1px solid var(--border);
    border-radius:20px;
    padding:24px;
    box-shadow:var(--shadow-lg);
    animation:slideUp 0.3s ease;
    max-height:90vh;
    overflow-y:auto;
  }
  
  @keyframes slideUp{
    from{
      opacity:0;
      transform:translateY(20px) scale(0.95);
    }
    to{
      opacity:1;
      transform:translateY(0) scale(1);
    }
  }
  
  .modal-header{
    display:flex;
    justify-content:space-between;
    align-items:start;
    margin-bottom:20px;
    padding-bottom:16px;
    border-bottom:1px solid var(--border);
  }
  
  .modal-verse-ref{
    font-size:20px;
    font-weight:600;
    color:var(--accent-light);
  }
  
  .modal-verse-text{
    font-size:16px;
    line-height:1.7;
    color:var(--text-primary);
    margin:20px 0;
    padding:20px;
    background:var(--bg-tertiary);
    border-radius:12px;
    border-left:4px solid var(--accent);
  }
  
  .small{
    font-size:13px;
    color:var(--text-muted);
  }
  
  .hidden{
    display:none;
  }
  
  .filter-section{
    display:flex;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
  }
  
  .filter-section label{
    color:var(--text-secondary);
    font-weight:500;
  }
  
  .filter-section select{
    background:var(--bg-tertiary);
    color:var(--text-primary);
    border:1px solid var(--border);
    padding:8px 12px;
    border-radius:8px;
    font-size:14px;
    cursor:pointer;
    transition:all 0.2s ease;
  }
  
  .filter-section select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:var(--focus);
  }
  
  .note-item, .fav-item{
    background:var(--bg-tertiary);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    margin-bottom:12px;
    transition:all 0.2s ease;
    cursor:pointer;
  }
  
  .note-item:hover, .fav-item:hover{
    background:var(--card-hover);
    transform:translateY(-1px);
    box-shadow:var(--shadow);
  }
  
  .fav-btn-active{
    background:linear-gradient(135deg, #f39c12, #e67e22) !important;
    color:#fff !important;
  }
  
  /* Scrollbar styling */
  ::-webkit-scrollbar{
    width:8px;
  }
  
  ::-webkit-scrollbar-track{
    background:var(--bg-secondary);
  }
  
  ::-webkit-scrollbar-thumb{
    background:var(--accent);
    border-radius:4px;
  }
  
  ::-webkit-scrollbar-thumb:hover{
    background:var(--accent-strong);
  }
/* Responsive 3-column grid for desktop (keep mobile single-column) */
.grid-list{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 12px;
}
@media (min-width: 1024px){
  .grid-list{
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
  }
}
/* Prefer wider letter tiles on mid-width phones/foldables (2-4 columns) */
@media (min-width: 480px) and (max-width: 1023px){
  .letters-grid{ grid-template-columns: repeat(4,1fr); gap:14px; }
  .letters-grid .letter-card{ min-height:74px; font-size:20px; }
  main{ max-width:980px; padding-left:16px; padding-right:16px; }
}


/* Mobile-specific: prefer wider, larger letter tiles on narrow screens */
@media (max-width: 479px){
  .letters-grid{ grid-template-columns: repeat(4, 1fr); gap:12px; }
  .letter-card{ padding:6px 8px; min-height:80px; font-size:24px; }
  .panel{ padding:18px; }
}
/* Prevent overscroll chaining (stop the page moving when interacting with tiles) */
html, body { overscroll-behavior: none; -webkit-overflow-scrolling: touch; }
/* Prevent horizontal overflow and ensure layout fits viewport */
html, body {
  max-width: 100vw;
  width: 100%;
  overflow-x: hidden; /* stop horizontal scrolling */
}
main, .panel {
  overflow-x: hidden;
  box-sizing: border-box;
}
/* allow grid children to shrink properly on narrow viewports */
.letters-grid, .grid-list, .list, .panel { min-width: 0; }
.letter-card, .cat-item, .verse-item { min-width: 0; }


@media (max-width: 640px){
  .panel-header > div:first-child .panel-title { flex: 1; text-align: center; margin: 0; }
  .panel-header > div:first-child .btn { margin-right: auto; }
}
/* On very narrow phones: center title, keep back button left, and hide the redundant helper text */
@media (max-width: 420px){
  .panel-header{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:flex-start; /* keep layout flow left-aligned */
    padding-top:12px;
    padding-bottom:12px;
    gap:8px;
  }
  /* keep the back button visually on the left */
  .panel-header .btn{
    position:absolute;
    left:12px;
    top:50%;
    transform:translateY(-50%);
    z-index:3;
  }
  /* align the title to the right side of the panel on narrow screens */
  .panel-header .panel-title{
    position:absolute;
    right:14px;
    top:50%;
    transform:translateY(-50%);
    margin:0;
    text-align:right;
    font-size:18px;
    line-height:1.05;
    z-index:2;
  }
  /* remove the redundant helper subtitle */
  .panel-header > .small{ display:none; }
}


/* larger circular back/home buttons in panel headers */
.panel-header .btn{
  width:64px;
  height:64px;
  padding:0;
  border-radius:50%;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
}
/* Circular letter tiles + consistent sizing (tweak --tile-size to taste) */
:root { --tile-size: 72px; } /* try 64–88px depending on device */
.letters-grid { justify-items: center; } /* center grid children */
.letter-card{
  width: var(--tile-size);
  height: var(--tile-size);
  padding: 0;
  border-radius: 50%;
  min-height: unset;
  font-size: 20px;
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1;
}


/* Make the header controls and common buttons circular / pill as needed */
.header-btn, .btn { border-radius: 999px; padding: 10px 14px; }
.panel-header .btn { /* specifically make the Back button circular */
  width:44px;
  height:44px;
  padding:0;
  border-radius:50%;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}


/* Keep badges (verse count) readable if using circular category tiles later */
.cat-item .small { /* no layout break if you later make category tiles circular */ 
  white-space:nowrap;
}




/* Responsive tile sizing (fluid, works across devices including foldables) */
:root{ --tile-min:48px; --tile-pref:72px; --tile-max:88px; }


/* Grid: auto-fit with a fluid min size so columns reflow to fit available width */
.letters-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(clamp(var(--tile-min), 8vw, var(--tile-pref)), 1fr));
  gap:8px;
  justify-items:center;
  width:100%;
  padding:8px 0;
  box-sizing:border-box;
}


/* Circular tiles driven by width; aspect-ratio keeps them true circles */
.letter-card{
  width: clamp(var(--tile-min), 9vw, var(--tile-pref));
  aspect-ratio: 1 / 1;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: clamp(14px, 2.2vw, 20px);
  line-height:1;
  padding:0;
  transition:all 0.18s ease;
}


/* Desktop / larger breakpoints: prefer fixed count but still allow shrink */
@media (min-width:720px){
  .letters-grid{ grid-template-columns: repeat(8, minmax(0,1fr)); gap:10px; }
  .letter-card{ width: var(--tile-pref); font-size:18px; }
}
@media (min-width:1024px){
  .letters-grid{ grid-template-columns: repeat(10, minmax(0,1fr)); gap:12px; }
  .letter-card{ width: var(--tile-pref); }
}


/* Prevent clipping: let panels scroll inside the viewport and respect safe areas */
.panel{
  max-height: calc(min(100dvh, 100vh) - 120px); /* header + padding reserve */
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: max(16px, env(safe-area-inset-bottom, 16px));
  box-sizing: border-box;
}


/* Allow main to respect fold/notch safe areas horizontally */
main{
  padding-left: max(16px, env(safe-area-inset-left, 16px));
  padding-right: max(16px, env(safe-area-inset-right, 16px));
  box-sizing:border-box;
}


/* If you still see bottom cutoff on some Samsung browsers, make panel full-height scrollable */
@media (max-width:420px){
  .panel{ max-height: calc(min(100dvh, 100vh) - 88px); } /* reduce reserved header space for tiny screens */
}


/* Force perfect circular letter tiles: override any min-height/padding that made them oval */
.letter-card{
  padding:0 !important;
  min-height:0 !important;
  height:auto !important;
  aspect-ratio:1 / 1 !important;
  border-radius:50% !important;
  display:flex;
  align-items:center;
  justify-content:center;
}


  @media (max-width: 600px) {
  .letters-grid {
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 8px !important;
  }
}


  :root{
  --tile-min:64px;   /* smallest on tiny phones */
  --tile-pref:100px; /* preferred tile size on most phones */
  --tile-max:140px;  /* cap for very large screens */
}


/* override width/font so tiles get bigger but stay circular */
.letter-card{
  width: clamp(var(--tile-min), 14vw, var(--tile-pref)) !important;
  aspect-ratio: 1 / 1 !important;
  font-size: clamp(16px, 3.5vw, 22px) !important;
  padding:0 !important;
}


  /* Fix overlap on foldables/tablets: let the cell control size */
.letters-grid{
  grid-template-columns: repeat(auto-fit, minmax(88px, 1fr)) !important;
  gap: 10px !important;
}


.letter-card{
  width: 100% !important;        /* fill the cell */
  max-width: 120px !important;    /* cap so they don't get huge */
  aspect-ratio: 1 / 1 !important; /* keep perfectly round */
  box-sizing: border-box;
}


/* optional: on very small phones keep 4 columns */
@media (max-width: 600px){
  .letters-grid{ grid-template-columns: repeat(4, 1fr) !important; }
}

/* ====== NEW: center titles globally (only change requested) ====== */
/* Center all panel titles (Choose a Letter, Categories, Verses, etc.) */
.panel-header { position: relative; }


.panel-header .panel-title {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  margin: 0;
  text-align: center;
  white-space: nowrap;
  max-width: calc(100% - 160px);
  overflow: hidden;
  text-overflow: ellipsis;
  pointer-events: none;
  z-index: 6;
  font-size: 18px; /* keeps existing size; change here if you want larger/smaller globally */
  line-height: 1;
}
/* ====== end global title centering ====== */



.panel-header { /* increase vertical space if needed */ padding-top: 20px; padding-bottom: 20px; }
.panel-header .panel-title {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  line-height: 1.2;   /* increase to avoid clipping descenders */
  font-size: 18px;    /* change here to resize titles */
}

/* ====== MOBILE-ONLY FIX: stack header and make title participate in flow to avoid overlap ====== */
@media (max-width: 720px) {
  .panel-header {
    display: flex !important;
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
    padding-top: 12px;
    padding-bottom: 12px;
  }
  .panel-header .panel-title {
    position: static !important;
    left: auto !important;
    top: auto !important;
    transform: none !important;
    margin: 0;
    text-align: center;
    pointer-events: auto !important;
    z-index: 2 !important;
    white-space: normal;
    max-width: 100%;
    overflow: visible;
  }
  .panel-header > div:first-child {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  .panel-header .filter-section {
    align-self: flex-end;
  }
  .panel-header .btn {
    position: relative !important;
    width: auto;
    height: auto;
    padding: 8px 12px;
    border-radius: 999px;
  }
}
/* ====== end mobile-only fix ====== */

</style>
</head>
<body>
<header>
  <div style="display:flex;gap:16px;align-items:center">
    <div class="logo">K</div>
    <div>
      <div class="header-title">Emotional Bible Verse Browser</div>
      <div class="header-subtitle">Enhanced — Navigate by emotion & theme</div>
    </div>
  </div>
  <div class="header-buttons">
    <button id="btn-notes" class="header-btn">📝 Notes</button>
    <button id="btn-favs" class="header-btn">⭐ Favorites</button>
  </div>
</header>
<main id="app"></main>
<div id="modal-root"></div>
<script>
const STORAGE_KEY='knock_emotion_db_v1';
const SEED={
  letters:[{key:'A',label:'A'},{key:'B',label:'B'}],
  categories:[
    {id:'cat-A-anger',letterKey:'A',name:'Anger',description:'Verses about managing anger and wrath',order:1},
    {id:'cat-A-accept',letterKey:'A',name:'Acceptance',description:'Finding peace through acceptance',order:2},
    {id:'cat-A-anxiety',letterKey:'A',name:'Anxiety',description:'Verses that calm anxious hearts',order:3},
    {id:'cat-A-assurance',letterKey:'A',name:'Assurance',description:'God\'s promises that reassure us',order:4},
    {id:'cat-A-awe',letterKey:'A',name:'Awe',description:'Verses that inspire reverent awe',order:5},
    {id:'cat-B-bless',letterKey:'B',name:'Blessing',description:'God\'s blessings and favor',order:1},
    {id:'cat-B-burden',letterKey:'B',name:'Burden',description:'Scripture about rest for the weary',order:2},
    {id:'cat-B-boldness',letterKey:'B',name:'Boldness',description:'Courage & boldness in faith',order:3},
    {id:'cat-C-comfort',letterKey:'C',name:'Comfort',description:'Comfort in times of sorrow',order:1},
    {id:'cat-D-doubt',letterKey:'D',name:'Doubt',description:'Scripture for wrestling through doubt',order:1}
  ],
  verses:[
    {id:'v1',categoryId:'cat-A-anger',reference:'Ephesians 4:26',text:'Be angry and do not sin; do not let the sun go down on your anger.',translation:'ESV',tags:['anger'],order:1,loadedAt:new Date().toISOString()},
    {id:'v2',categoryId:'cat-A-anger',reference:'Proverbs 15:1',text:'A soft answer turns away wrath, but a harsh word stirs up anger.',translation:'ESV',tags:['anger'],order:2,loadedAt:new Date().toISOString()},
    {id:'v3',categoryId:'cat-A-accept',reference:'Romans 15:7',text:'Welcome one another, therefore, as Christ has welcomed you, for the glory of God.',translation:'ESV',tags:['accept'],order:1,loadedAt:new Date().toISOString()},
    {id:'v4',categoryId:'cat-A-anxiety',reference:'Philippians 4:6-7',text:'Do not be anxious about anything, but in everything by prayer and supplication with thanksgiving let your requests be made known to God. And the peace of God, which surpasses all understanding, will guard your hearts and your minds in Christ Jesus.',translation:'ESV',tags:['anxiety'],order:1,loadedAt:new Date().toISOString()},
    {id:'v5',categoryId:'cat-A-anxiety',reference:'Matthew 6:26',text:'Look at the birds of the air: they neither sow nor reap nor gather into barns, and yet your heavenly Father feeds them. Are you not of more value than they?',translation:'ESV',tags:['anxiety'],order:2,loadedAt:new Date().toISOString()},
    {id:'v6',categoryId:'cat-A-assurance',reference:'Romans 8:38-39',text:'For I am sure that neither death nor life, nor angels nor rulers, nor things present nor things to come, nor powers, nor height nor depth, nor anything else in all creation, will be able to separate us from the love of God in Christ Jesus our Lord.',translation:'ESV',tags:['assurance'],order:1,loadedAt:new Date().toISOString()},
    {id:'v7',categoryId:'cat-A-awe',reference:'Psalm 46:10',text:'Be still, and know that I am God. I will be exalted among the nations, I will be exalted in the earth!',translation:'ESV',tags:['awe'],order:1,loadedAt:new Date().toISOString()},
    {id:'v8',categoryId:'cat-B-bless',reference:'Numbers 6:24-26',text:'The Lord bless you and keep you; the Lord make his face to shine upon you and be gracious to you; the Lord lift up his countenance upon you and give you peace.',translation:'ESV',tags:['bless'],order:1,loadedAt:new Date().toISOString()},
    {id:'v9',categoryId:'cat-B-burden',reference:'Matthew 11:28',text:'Come to me, all who labor and are heavy laden, and I will give you rest.',translation:'ESV',tags:['burden'],order:1,loadedAt:new Date().toISOString()},
    {id:'v10',categoryId:'cat-B-boldness',reference:'Joshua 1:9',text:'Have I not commanded you? Be strong and courageous. Do not be frightened, and do not be dismayed, for the Lord your God is with you wherever you go.',translation:'ESV',tags:['boldness'],order:1,loadedAt:new Date().toISOString()},
    {id:'v11',categoryId:'cat-A-anxiety',reference:'1 Peter 5:7',text:'Cast all your anxiety on him because he cares for you.',translation:'ESV',tags:['anxiety'],order:1,loadedAt:new Date().toISOString()},
    {id:'v12',categoryId:'cat-A-assurance',reference:'Isaiah 41:10',text:'Fear not, for I am with you; be not dismayed, for I am your God...',translation:'ESV',tags:['assurance'],order:1,loadedAt:new Date().toISOString()},
    {id:'v13',categoryId:'cat-A-awe',reference:'Psalm 95:4',text:'In his hand are the depths of the earth; the heights of the mountains are his also.',translation:'ESV',tags:['awe'],order:1,loadedAt:new Date().toISOString()},
    {id:'v14',categoryId:'cat-B-burden',reference:'Psalm 55:22',text:'Cast your burden on the Lord, and he will sustain you.',translation:'ESV',tags:['burden'],order:1,loadedAt:new Date().toISOString()},
    {id:'v15',categoryId:'cat-B-boldness',reference:'Acts 4:29',text:'And now, Lord, look upon their threats and grant to your servants to speak your word with all boldness.',translation:'ESV',tags:['boldness'],order:1,loadedAt:new Date().toISOString()},
    {id:'v16',categoryId:'cat-C-comfort',reference:'2 Corinthians 1:3-4',text:'Blessed be the God and Father of our Lord Jesus Christ, the Father of mercies and God of all comfort...',translation:'ESV',tags:['comfort'],order:1,loadedAt:new Date().toISOString()},
    {id:'v17',categoryId:'cat-D-doubt',reference:'Mark 9:24',text:'Immediately the father of the child cried out and said, “I believe; help my unbelief!”',translation:'ESV',tags:['doubt'],order:1,loadedAt:new Date().toISOString()}
  ],
  notes:[],favorites:[],meta:{seedAt:new Date().toISOString(),version:'enhanced-seed'}
};


let DB=null; 
const app=document.getElementById('app'), modalRoot=document.getElementById('modal-root');


function load(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw){
    DB=SEED;
    save();
  }else{
    try{
      DB=JSON.parse(raw);
    }catch(e){
      DB=SEED;
      save();
    }
  }
  // ensure full alphabet present without overwriting user data
  const FULL_LETTERS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').map(c=>({key:c,label:c}));
  if(!DB.letters || DB.letters.length < 26){ 
    DB.letters = FULL_LETTERS; 
    save(); 
  }
}


function save(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(DB));
}


function mount(){
  app.innerHTML='';
  if(state.view==='home') renderHome();
  else if(state.view==='categories') renderCategories();
  else if(state.view==='verses') renderVerses();
  else if(state.view==='notes') renderNotes();
  else if(state.view==='favorites') renderFavorites();
}


const state={view:'home',selectedLetter:null,selectedCategory:null};


function renderHome(){
  const panel=document.createElement('div');
  panel.className='panel';
  panel.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">Choose a Letter</div>
      <div class="small">Browse emotions & themes alphabetically</div>
    </div>
    <div class="letters-grid" id="lg"></div>
  `;
  app.appendChild(panel);
  
  const grid=panel.querySelector('#lg');
  DB.letters.forEach(l=>{
    const b=document.createElement('div');
    b.className='letter-card';
    b.tabIndex=0;
    b.innerText=l.label;
    b.onclick = () => {
      state.selectedLetter=l.key;
      state.view='categories';
      mount();
    };
    b.addEventListener('keypress', (e)=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        b.onclick();
      }
    });
    grid.appendChild(b);
  });
}


function renderCategories(){
  const letter=state.selectedLetter;
  const panel=document.createElement('div');
  // Add modifier class so CSS targets only this page's header
  panel.className='panel';
  panel.innerHTML=`
    <div class="panel-header panel-header--center-title">
      <div style="display:flex;align-items:center;gap:12px">
        <button id='back' class='btn btn-secondary'>← Back</button> 
        <div class="panel-title">Categories for ${letter}</div>
      </div>
              <div class="small slate">Select a category to explore verses</div>
    </div>
    <div class="list" id="cats"></div>
  `;
  app.appendChild(panel);


  panel.querySelector('#cats').classList.add('grid-list');
panel.querySelector('#back').onclick = () => {
    state.view='home';
    mount();
  };
  
  const list=panel.querySelector('#cats');
  const categories = DB.categories.filter(c=>c.letterKey===letter);
  
  if(categories.length === 0){
    list.innerHTML=`<div class="small" style="text-align:center;padding:40px;color:var(--text-muted)">No categories available for letter ${letter} yet.</div>`;
    return;
  }
  
  categories.forEach(c=>{
    const verseCount = DB.verses.filter(v=>v.categoryId===c.id).length;
    const d=document.createElement('div');
    d.className='cat-item';
    d.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:600;font-size:16px;color:var(--text-primary);margin-bottom:4px">${c.name}</div>
          <div class="small">${c.description||'No description'}</div>
        </div>
      </div>
    `;
    d.onclick = () => {
      state.selectedCategory=c.id;
      state.view='verses';
      mount();
    };
    list.appendChild(d);
  });
}


function renderVerses(){
  const cat=DB.categories.find(x=>x.id===state.selectedCategory);
  const verses = DB.verses.filter(v=>v.categoryId===cat.id);
  
  const panel=document.createElement('div');
  panel.className='panel';
  // Add modifier class so CSS targets only this page's header
  panel.innerHTML=`
    <div class="panel-header panel-header--center-title">
      <div style="display:flex;align-items:center;gap:12px">
        <button id='back' class='btn btn-secondary'>← Back</button> 
        <div class="panel-title">${cat.name}</div>
      </div>
      <div class="small">${verses.length} verse${verses.length !== 1 ? 's' : ''} available</div>
    </div>
    <div class='list verses-grid' id='vs'></div>
  `;
  app.appendChild(panel);


  const vsEl = panel.querySelector('#vs');
  if (vsEl) vsEl.classList.add('grid-list');
panel.querySelector('#back').onclick = () => {
    state.view='categories';
    mount();
  };
  
  const list=panel.querySelector('#vs');
  
  if(verses.length === 0){
    list.innerHTML=`<div class="small" style="text-align:center;padding:40px;color:var(--text-muted)">No verses available in this category yet.</div>`;
    return;
  }
  
  verses.forEach(v=>{
    const el=document.createElement('div');
    el.className='verse-item';
    el.innerHTML=`
      <div class='verse-ref'>${v.reference} <span class='small'>${v.translation}</span></div>
      <div class='verse-text'>${v.text}</div>
    `;
    el.onclick = () => openVerseDetail(v.id);
    list.appendChild(el);
  });
}


function openVerseDetail(id, opts = {}){
  const v=DB.verses.find(x=>x.id===id);
  const isFav = DB.favorites.some(f=>f.verseId===id);
  
  modalRoot.innerHTML=`
    <div class='modal-backdrop' id='backdrop'>
      <div class='modal' role='dialog' aria-modal='true' tabindex='-1'>
        <div class="modal-header">
          <div>
            <div class="modal-verse-ref">${v.reference}</div>
            <div class='small'>${v.translation}</div>
          </div>
        </div>
        <div class="modal-verse-text">${v.text}</div>
        <div style='margin-top:20px'>
          <div class='small' style="margin-bottom:8px;font-weight:500">Personal Note (autosave)</div>
          <textarea id='note' class='note-editor' aria-label='Note for ${v.reference}' placeholder="Add your personal thoughts, prayers, or reflections..."></textarea>
          <div style='margin-top:16px;display:flex;gap:12px;flex-wrap:wrap'>
            <button id='favBtn' class='btn ${isFav ? 'fav-btn-active' : ''}' aria-pressed='${isFav}'>
              ${isFav ? '⭐ Favorited' : '☆ Add to Favorites'}
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  const backdrop = document.getElementById('backdrop');
  // click outside to close
  backdrop.addEventListener('click', (e)=>{ 
    if(e.target && e.target.id==='backdrop'){ 
      modalRoot.innerHTML=''; 
      modalRoot.setAttribute('aria-hidden','true'); 
    } 
  });
  
  // esc to close
  backdrop.addEventListener('keydown', (e)=>{ 
    if(e.key==='Escape'){ 
      modalRoot.innerHTML=''; 
      modalRoot.setAttribute('aria-hidden','true'); 
    } 
  });
  
  // populate note if exists
  const ta=document.getElementById('note'); 
  const existing=DB.notes.find(n=>n.verseId===id); 
  if(existing) ta.value=existing.text;
  
  let tmr=null; 
  ta.addEventListener('input', ()=>{ 
    clearTimeout(tmr); 
    tmr=setTimeout(()=>{ 
      saveNote(id,ta.value); 
    },700); 
  });
  
  // favorite button
  const favBtn = document.getElementById('favBtn');
  function refreshFavUI(){ 
    const isFav = DB.favorites.some(f=>f.verseId===id); 
    favBtn.textContent = isFav ? '⭐ Favorited' : '☆ Add to Favorites';
    favBtn.className = `btn ${isFav ? 'fav-btn-active' : ''}`;
    favBtn.setAttribute('aria-pressed', String(isFav)); 
  }
  
  refreshFavUI(); 
  favBtn.onclick = () =>{
    toggleFav(id); 
    refreshFavUI(); 
    if(state.view === 'favorites'){ 
      modalRoot.innerHTML=''; 
      modalRoot.setAttribute('aria-hidden','true'); 
      mount(); 
    } 
  };
  
  modalRoot.setAttribute('aria-hidden','false');
  
  // if caller requested focus on the note, focus textarea after modal mounted
  if(opts.focusNote){ 
    setTimeout(()=>{ 
      try{ 
        ta.focus(); 
        ta.setSelectionRange(ta.value.length, ta.value.length);
      }catch(e){} 
    }, 100); 
  }
}


function saveNote(verseId,text){
  const ex=DB.notes.find(n=>n.verseId===verseId); 
  if(ex){ 
    ex.text=text; 
    ex.updatedAt=new Date().toISOString(); 
  } else { 
    DB.notes.push({
      id:'n-'+Math.random().toString(36).slice(2,8),
      verseId,
      text,
      createdAt:new Date().toISOString(),
      updatedAt:new Date().toISOString()
    }); 
  } 
  save(); 
}


function toggleFav(verseId){
  const f=DB.favorites.find(x=>x.verseId===verseId); 
  if(f){
    DB.favorites=DB.favorites.filter(x=>x.id!==f.id);
  }else{
    DB.favorites.push({
      id:'f-'+Math.random().toString(36).slice(2,8),
      verseId,
      addedAt:new Date().toISOString()
    });
  } 
  save(); 
}


function renderNotes(){
  const panel=document.createElement('div');
  panel.className='panel';
  panel.innerHTML=`
    <div class="panel-header">
      <div style="display:flex;align-items:center;gap:12px">
        <button id='back' class='btn btn-secondary'>← Home</button> 
        <div class="panel-title">📝 Your Notes</div>
      </div>
      <div class="filter-section">
        <label class='small' for='notesCat'>Filter by:</label>
        <select id='notesCat' aria-label='Filter notes by category'>
          <option value='ALL'>All Categories</option>
        </select>
      </div>
    </div>
    <div id='nl' class='list'></div>
  `;
  
  app.appendChild(panel);
  
  panel.querySelector('#back').onclick = () => {
    state.view='home';
    mount();
  };
  
  const notesCat = panel.querySelector('#notesCat');
  // populate category options
  const cats = DB.categories.slice().sort((a,b)=>a.name.localeCompare(b.name));
  cats.forEach(c=>{ 
    const opt = document.createElement('option'); 
    opt.value = c.id; 
    opt.textContent = c.name; 
    notesCat.appendChild(opt); 
  });
  
  notesCat.value = state.noteFilterCategory || 'ALL';
  notesCat.addEventListener('change', ()=>{ 
    state.noteFilterCategory = notesCat.value; 
    renderNotesList(); 
  });
  
  function renderNotesList(){ 
    const nl=panel.querySelector('#nl'); 
    nl.innerHTML='';
    
    let notesToShow = DB.notes.slice().sort((a,b)=>new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt));
    
    if(state.noteFilterCategory && state.noteFilterCategory!=='ALL'){ 
      notesToShow = notesToShow.filter(n=>{ 
        const v = DB.verses.find(x=>x.id===n.verseId); 
        return v && v.categoryId===state.noteFilterCategory; 
      }); 
    }
    
    if(!notesToShow.length){ 
      nl.innerHTML="<div class='small' style='text-align:center;padding:40px;color:var(--text-muted)'>No notes found for this selection.</div>"; 
      return; 
    }
    
    notesToShow.forEach(n=>{
      const v=DB.verses.find(x=>x.id===n.verseId)||{}; 
      const cat = DB.categories.find(c=>c.id===v.categoryId) || {};
      const d=document.createElement('div'); 
      d.className='note-item';
      d.innerHTML=`
        <div style='display:flex;justify-content:space-between;align-items:start;margin-bottom:12px'>
          <div>
            <div style="font-weight:600;color:var(--accent-light);margin-bottom:4px">${v.reference||'Unknown'}</div>
            <div class='small'>${cat.name ? cat.name + ' • ' : ''}${v.translation||''}</div>
          </div>
          <div class='small'>${new Date(n.updatedAt||n.createdAt).toLocaleDateString()}</div>
        </div>
        <div style="color:var(--text-primary);line-height:1.5">${n.text||'<span class="small">[empty note]</span>'}</div>
      `;
      d.onclick = () => openVerseDetail(n.verseId, {focusNote: true});
      nl.appendChild(d);
    });
  }
  renderNotesList();
}


function renderFavorites(){
  const panel=document.createElement('div');
  panel.className='panel';
  panel.innerHTML=`
    <div class="panel-header">
      <div style="display:flex;align-items:center;gap:12px">
        <button id='back' class='btn btn-secondary'>← Home</button> 
        <div class="panel-title">⭐ Your Favorites</div>
      </div>
      <div class="filter-section">
        <label class="small" for="favsCat">Filter by:</label>
        <select id="favsCat" aria-label="Filter favorites by category">
          <option value='ALL'>All Categories</option>
        </select>
      </div>
    </div>
    <div id='fl' class='list'></div>
  `;
  
  app.appendChild(panel);
  
  panel.querySelector('#back').onclick = () => {
    state.view='home';
    mount();
  };
  
  const favsCat = panel.querySelector('#favsCat');
  // populate category options
  const cats = DB.categories.slice().sort((a,b)=>a.name.localeCompare(b.name));
  cats.forEach(c=>{ 
    const opt = document.createElement('option'); 
    opt.value = c.id; 
    opt.textContent = c.name; 
    favsCat.appendChild(opt); 
  });
  
  favsCat.value = state.favsFilterCategory || 'ALL';
  favsCat.addEventListener('change', ()=>{ 
    state.favsFilterCategory = favsCat.value; 
    renderFavoritesList(); 
  });


  function renderFavoritesList(){
    const fl=panel.querySelector('#fl'); 
    fl.innerHTML='';
    
    let favsToShow = DB.favorites.slice().sort((a,b)=>new Date(b.addedAt)-new Date(a.addedAt));
    
    if(state.favsFilterCategory && state.favsFilterCategory!=='ALL'){
      favsToShow = favsToShow.filter(f=>{ 
        const v = DB.verses.find(x=>x.id===f.verseId); 
        return v && v.categoryId===state.favsFilterCategory; 
      });
    }
    
    if(!favsToShow.length){ 
      fl.innerHTML="<div class='small' style='text-align:center;padding:40px;color:var(--text-muted)'>No favorites for this selection.</div>"; 
      return; 
    }
    
    favsToShow.forEach(f=>{
      const v=DB.verses.find(x=>x.id===f.verseId)||{}; 
      const d=document.createElement('div'); 
      d.className='fav-item';
      d.setAttribute('role','button'); 
      d.tabIndex=0; 
      
      // show category and timestamp inside the tile
      const cat = DB.categories.find(c=>c.id===v.categoryId) || {};
      d.innerHTML=`
        <div style='display:flex;justify-content:space-between;align-items:start;margin-bottom:12px'>
          <div>
            <div style="font-weight:600;color:var(--accent-light);margin-bottom:4px">${v.reference||'Unknown'}</div>
            <div class='small'>${cat.name ? cat.name + ' • ' : ''}${v.translation||''}</div>
          </div>
          <div class='small'>⭐ ${new Date(f.addedAt).toLocaleDateString()}</div>
        </div>
        <div style="color:var(--text-primary);line-height:1.6">${v.text}</div>
      `;
      
      // clicking the tile opens the verse detail; if a note exists, the note will be visible/focused
      d.onclick = ()=>{ 
        const noteExists = DB.notes.some(n=>n.verseId===v.id); 
        openVerseDetail(v.id, {focusNote: noteExists}); 
      };
      
      // keyboard support
      d.addEventListener('keypress', (e)=>{ 
        if(e.key==='Enter' || e.key===' ') { 
          e.preventDefault(); 
          d.onclick(); 
        } 
      });
      
      fl.appendChild(d);
    });
  }
  renderFavoritesList();
}


// header buttons
document.getElementById('btn-notes').onclick = () => {
  state.view='notes';
  mount();
};



document.getElementById('btn-favs').onclick = () => {
  state.view='favorites';
  mount();
};


// init
load();
mount();


/* Prevent page dragging when touching interactive tiles on mobile */
(function(){
  const preventHandler = function(e){ e.preventDefault(); };
  function onTouchStart(e){
    try{
      if(e.target && e.target.closest && e.target.closest('.letter-card, .cat-item, .verse-item, .btn')){
        document.addEventListener('touchmove', preventHandler, {passive:false});
      }
    }catch(err){}
  }
  function onTouchEnd(){
    document.removeEventListener('touchmove', preventHandler, {passive:false});
  }
  document.addEventListener('touchstart', onTouchStart, {passive:true});
  document.addEventListener('touchend', onTouchEnd, {passive:true});
  document.addEventListener('touchcancel', onTouchEnd, {passive:true});
})();


/* Swipe-to-go-back: cross-device simple detector (swipe right to go back) */
(function(){
  let startX=0, startY=0, startTime=0, tracking=false;
  const minDist = 50; // minimum horizontal swipe distance in px
  const maxYDelta = 80; // allow some vertical movement
  function shouldIgnore(e){
    const el = e.target || e.srcElement;
    if(!el) return false;
    try{
      if(el.closest && el.closest('input, textarea, button, .note-editor')) return true;
    }catch(err){}
    if(typeof modalRoot !== 'undefined' && modalRoot && modalRoot.children && modalRoot.children.length) return true; // don't swipe when modal open
    return false;
  }
  function onStart(e){
    if(shouldIgnore(e)) return;
    tracking = true;
    startTime = Date.now();
    if(e.touches && e.touches[0]){
      startX = e.touches[0].clientX; startY = e.touches[0].clientY;
    }else{
      startX = e.clientX; startY = e.clientY;
    }
  }
  function onEnd(e){
    if(!tracking) return; tracking = false;
    let endX=0, endY=0;
    if(e.changedTouches && e.changedTouches[0]){ endX = e.changedTouches[0].clientX; endY = e.changedTouches[0].clientY; }
    else { endX = e.clientX; endY = e.clientY; }
    const dx = endX - startX; const dy = Math.abs(endY - startY);
    if(dx > minDist && dy < Math.max(30, Math.min(maxYDelta, Math.abs(dx)*0.6))){
      // avoid clashing with OS edge-swipe: require swipe start not extremely close to left edge
      if(startX <= 20) return;
      try{
        if(typeof state !== 'undefined'){
          if(state.view === 'verses') state.view = 'categories';
          else if(state.view === 'categories') state.view = 'home';
          else if(state.view === 'notes' || state.view === 'favorites') state.view = 'home';
          else return;
          mount();
        }
      }catch(err){}
    }
  }
  document.addEventListener('touchstart', onStart, {passive:true});
  document.addEventListener('touchend', onEnd, {passive:true});
  document.addEventListener('pointerdown', onStart, {passive:true});
  document.addEventListener('pointerup', onEnd, {passive:true});
})();
</script>
</body>
</html>
